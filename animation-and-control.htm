<!DOCTYPE html>
<html>
<head>
<meta charset="utf8" />
<title>Анимация и контроль</title>
</head>
<body>

<table><tr><td style="vertical-align:top;">
<h1>Анимация и контроль</h1>
</td><td style="vertical-align:top;">
<a href="index.htm">Блог Всячепуза</a>
<br />
&nbsp;
</td></tr></table>

Мне непонятно, как работать с анимацией и контролем одновременно.
<br />
Анимация происходит сама-по-себе по собственной инициативе (и визуально долго, чтобы было красиво), 
а контроль идёт со стороны игрока в то же самое время
<br />
прямо сейчас в freeciv интерфейс на время анимации блокируется, мне это кажется неудобным
<br />
я считаю, что недоступными должны быть только анимируемые юниты и элементы модели, задействованные в операциях анимируемых юнитов
<br />
а всё остальное должно быть доступно игроку для управления как обычно
<br />
<br />
Как обычно делают анимацию:
<br />
Пользователь выполняет действие с моделью. Действие разбивается на шаги. Шаги анимируются.
<br />
Если анимируемое действие должно быть атомарным для игрока с точки зрения управляемости, то на время выполнения шагов 
анимируемые объекты становятся неуправляемыми.
<br />
<br />
пример частичной неуправляемости - корабли в полёте в игре freeorion. Они могут лететь несколько ходов, но при перенаправлении должно учитываться их состояние.
<br />
в freeciv тоже такое есть - если отправить вертолёт на несколько ходов, то он полетит с остановками каждый ход и возможностью перенаправления,
при этом планируемый путь запоминается
<br />
То есть, длинное действие разбиваем по ходам, в пределах одного хода анимация непрерываема.
<br />
<br />
Анимация занимает сколько-то шагов (для того, чтобы быть плавной).
<br />
Запускают "таймер", таймер через определенные интервалы времени вызывает событие, код которого выполняет очередной шаг анимации.
<br />
<br />
Кроме freeciv ещё есть модельная игра "плоские танки". Её отличие в том, что управление выполняется не по ходам, а "в реальном времени".
<br />
Можно ли сказать, что здесь один ход равен одному шагу анимации? Это позволило бы свести задачу к предыдущей, более сложной.
<br />
Тут можно принять решение, что для разных танков выполнение не полностью асинхронное, а синхронизируется шагами анимации.
<br />
В момент синхронизции можно вычислить положение всех элементов и сымитировать коллизии и попадания симметрично (раноправно) для взаимодействующих сторон,
чтобы не получилось что кто-то реагирует на реакцию противника из-за несовершенства имитатора (изежать, например, такой ситуации - два танка стреляют друг в друга,
оба попадают, но движек зачел первое попадание, а второе попадание не зачтено, потому что от уже "мертвого" противника).
<br />
Для пиксельной анимации это должно работать так же хорошо, как и для поклеточной (просто шаги будут попиксельные, а не поклеточные)
<br />
Для субпиксельной анимации всё это должно работать так же хорошо (просто шаги будут субпиксельные, а не попиксельные)
<br />
<br />
Вопрос в том, что если есть моменты синхронизации, то зачем нужна многопоточность? можно было бы обойтись одним потоком, который рассчитывает собственно 
моменты синхронизации (конечно, ЦПУ будет лучше использоваться для расчета стратегий AI-танков, но там же мизерные затраты, или нет?)
<br />
<br />
Можно сказать, что есть две модели:
<br />
отображаемая модель и логическая модель. Отображается только часть логической модели, видимая в данный момент
(вероятно - либо меньшая по размеру, либо с меньшей детализацией прорисовки, то есть карта, а не территория).
<br />
действие переводит логическую модель из одного состояния в другое. То есть, в двух версиях модели (до и после действия)
появляются различающиеся элементы.
<br />
все действия одной стороны некоторым образом упорядочены (в порядке совершения действия пользователя, например)
<br />
можно сказать, что действие - это такая транзакция, которая должна быть выполнена целиком (atomicity).
<br />
<br />
можно поискать действия, которые не пересекаются по элементам (<font style="color:red">как найти непересекающиеся действия?</font> (транзакции?) могут ли быть неявные зависимости? "грязное чтение", например, ещё что-нибудь?)
для того, чтобы выполнить (анимировать) такие действия параллельно (одновременно с точки зрения номеров шагов анимации)
<br />
так же можно поискать и сгруппировать групповые действия (например Ctrl-V выделили 50 юнитов, самолётов, и отправили атаковать город, в этом случае не надо
анимировать каждый поштучно в начале хода, потому что это долго)
<br />
<br />
Что надо делать, чтобы сделать? Выписать все возможные юниты и элементы модели (города, клетки, модификаторы), выписать все возможные действия,
для каждого действия научиться определять множества блокируемых элементов, научиться находить пересечения множеств, научиться составлять списки непересекающихся действий
<br />
<br />
Как избежать неравноправия искинов в freeciv? (они могут реагировать только в моменты ходов, а надо бы на каждое действие разных игроков)

</body>
</html>
